{{ if and (not .ephemeral) (or (eq .osid "linux-ubuntu") (eq .osid "linux-debian") (eq .osid "linux-raspbian")) -}}
#!/bin/bash

set -eufo pipefail

echo "Setting up Bitwarden CLI for Linux..."

# Force Linux PATH to take precedence over Windows paths in WSL
export PATH="/usr/local/bin:/usr/bin:/bin:$HOME/.local/bin:$HOME/.local/npm-global/bin:$PATH"

# Remove any Windows Node.js/npm from PATH in WSL
if [[ -n "${WSL_DISTRO_NAME:-}" ]] || [[ -n "${WSL_INTEROP:-}" ]]; then
    echo "üêß Detected WSL environment - prioritizing Linux binaries"
    # Filter out Windows paths that might interfere
    export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v '/mnt/[a-z]/' | tr '\n' ':' | sed 's/:$//')
    export PATH="/usr/local/bin:/usr/bin:/bin:$HOME/.local/bin:$HOME/.local/npm-global/bin:$PATH"
fi

# Check if we have a working Linux installation
if command -v bw >/dev/null 2>&1; then
    BW_PATH=$(which bw)
    echo "Found Bitwarden CLI at: $BW_PATH"

    # Check if it's a Linux binary (not Windows)
    if [[ "$BW_PATH" == /mnt/* ]]; then
        echo "‚ö†Ô∏è  Found Windows Bitwarden CLI, installing Linux version..."
    elif timeout 5 bw --version >/dev/null 2>&1; then
        echo "‚úÖ Linux Bitwarden CLI is already installed and working"
        exit 0
    else
        echo "‚ö†Ô∏è  Found Bitwarden CLI but it's not working, reinstalling..."
    fi
fi

# Ensure we're using Linux Node.js and npm
if command -v node >/dev/null 2>&1; then
    NODE_PATH=$(which node)
    if [[ "$NODE_PATH" == /mnt/* ]]; then
        echo "‚ö†Ô∏è  Detected Windows Node.js, this may cause issues"
        echo "Using Linux Node.js from apt installation"
    fi
fi

# Method 1: Try npm with Linux Node.js (most reliable for WSL)
if command -v npm >/dev/null 2>&1; then
    NPM_PATH=$(which npm)
    echo "Using npm at: $NPM_PATH"

    if [[ "$NPM_PATH" != /mnt/* ]]; then  # Ensure we're using Linux npm
        echo "Setting up npm for local installations..."

        # Create local npm directory
        mkdir -p "$HOME/.local/npm-global"

        # Configure npm to use local directory
        npm config set prefix "$HOME/.local/npm-global"

        # Add to PATH for current session
        export PATH="$HOME/.local/npm-global/bin:$PATH"

        # Install Bitwarden CLI
        echo "Installing Bitwarden CLI via Linux npm..."
        if npm install -g @bitwarden/cli; then
            echo "‚úÖ Successfully installed Bitwarden CLI via npm"

            # Add to shell profiles for persistence
            for profile in "$HOME/.zshrc" "$HOME/.bashrc"; do
                if [[ -f "$profile" ]] && ! grep -q "npm-global/bin" "$profile" 2>/dev/null; then
                    echo 'export PATH="$HOME/.local/npm-global/bin:$PATH"' >> "$profile"
                fi
            done

            # Test the installation
            if timeout 5 "$HOME/.local/npm-global/bin/bw" --version >/dev/null 2>&1; then
                echo "‚úÖ Bitwarden CLI test successful"
                exit 0
            fi
        else
            echo "‚ùå npm installation failed, trying alternative methods..."
        fi
    fi
fi

# Method 2: Direct download (most reliable fallback)
echo "Trying direct download method..."
BW_VERSION=$(curl -s https://api.github.com/repos/bitwarden/clients/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/cli-v//')

if [ -n "$BW_VERSION" ]; then
    echo "Downloading Bitwarden CLI version $BW_VERSION..."

    # Detect architecture
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) BW_ARCH="x86_64" ;;
        aarch64|arm64) BW_ARCH="aarch64" ;;
        armv7l) BW_ARCH="armv7" ;;
        *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
    esac

    # Download and install
    if wget -O "/tmp/bw-linux-${BW_ARCH}.zip" "https://github.com/bitwarden/clients/releases/download/cli-v${BW_VERSION}/bw-linux-${BW_ARCH}-${BW_VERSION}.zip"; then
        if unzip -o "/tmp/bw-linux-${BW_ARCH}.zip" -d /tmp/ && [ -f "/tmp/bw" ]; then
            chmod +x /tmp/bw
            mkdir -p "$HOME/.local/bin"
            mv /tmp/bw "$HOME/.local/bin/"
            rm -f "/tmp/bw-linux-${BW_ARCH}.zip"

            # Test the installation
            if timeout 5 "$HOME/.local/bin/bw" --version >/dev/null 2>&1; then
                echo "‚úÖ Successfully installed Bitwarden CLI via direct download"
                exit 0
            fi
        fi
    fi
fi

# Method 3: Try snap as last resort
if command -v snap >/dev/null 2>&1; then
    echo "Trying to install Bitwarden CLI via snap..."
    if sudo snap install bw 2>/dev/null; then
        echo "‚úÖ Installed Bitwarden CLI via snap"
        exit 0
    fi
fi

echo "‚ö†Ô∏è  Could not install Bitwarden CLI automatically"
echo "You can install it manually with one of these methods:"
echo "  1. npm install -g @bitwarden/cli"
echo "  2. sudo snap install bw"
echo "  3. Download from: https://github.com/bitwarden/clients/releases"
{{ end -}}
